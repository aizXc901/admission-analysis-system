<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обновление данных - Московская предпрофессиональная олимпиада школьников</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #0d6efd, #0b5ed7);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            height: 100%;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        .status-card {
            border-left: 4px solid #0d6efd;
        }
        .feature-icon {
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, #0d6efd, #6ea8fe);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            margin-right: 1rem;
        }
        .progress-container {
            display: none;
            margin-top: 1rem;
        }
        .alert {
            display: none;
        }
        footer {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            margin-top: 3rem;
        }
    </style>
</head>
<body>
    <!-- Заголовок -->
    <div class="header text-center">
        <div class="container">
            <h1 class="display-5 fw-bold">Московская предпрофессиональная олимпиада школьников</h1>
            <p class="lead mb-0">Профиль «Информационные технологии»</p>
            <p class="lead mb-0">Командный кейс No 3 «Анализ поступления»</p>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-lg-12">
                <h2 class="text-center mb-4">Обновление данных</h2>
                <div class="card p-4 status-card">
                    <div class="card-body">
                        <h5 class="card-title">Функциональность обновления данных</h5>
                        <p class="card-text">Данная страница позволяет обновить базу данных абитуриентов на основе новых конкурсных списков.</p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex align-items-center">
                                <span class="feature-icon">✓</span>
                                <div>
                                    <strong>Удаление</strong> - Удаляет информацию об абитуриентах, которые отсутствуют в новой версии конкурсных списков
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <span class="feature-icon">✓</span>
                                <div>
                                    <strong>Добавление</strong> - Добавляет информацию об абитуриентах, которые присутствуют в новой версии, но отсутствуют в БД
                                </div>
                            </li>
                            <li class="list-group-item d-flex align-items-center">
                                <span class="feature-icon">✓</span>
                                <div>
                                    <strong>Обновление</strong> - Обновляет информацию об абитуриентах, которые присутствуют и в новой версии, и в БД
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Загрузить новые данные</h5>
                    </div>
                    <div class="card-body">
                        <form id="updateForm">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Выберите файлы с новыми конкурсными списками</label>
                                <input type="file" class="form-control" id="fileInput" accept=".csv,.xlsx,.xls" multiple>
                                <div class="form-text">Поддерживаются форматы CSV и Excel (XLSX)</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="updateBtn">Обновить данные</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Информация о процессе</h5>
                    </div>
                    <div class="card-body">
                        <div id="progressContainer" class="progress-container">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                            </div>
                            <p class="mt-2 text-center" id="progressText">Обновление данных...</p>
                        </div>
                        <div id="resultAlert" class="alert alert-dismissible fade show" role="alert">
                            <span id="alertMessage"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Статус обновления</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Дата</th>
                                        <th>Операция</th>
                                        <th>Количество записей</th>
                                        <th>Статус</th>
                                        <th>Время выполнения</th>
                                    </tr>
                                </thead>
                                <tbody id="updateHistory">
                                    <tr>
                                        <td colspan="5" class="text-center">История обновлений будет отображаться здесь</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-auto py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p class="mb-0">&copy; 2023 Московская предпрофессиональная олимпиада школьников. Все права защищены.</p>
                    <p class="mb-0">Профиль «Информационные технологии»</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('updateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showAlert('danger', 'Пожалуйста, выберите файлы для обновления данных');
                return;
            }

            // Показываем прогресс
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultAlert').style.display = 'none';

            // Создаем FormData для отправки файлов
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            // Отправляем запрос на обновление данных
            fetch('/update-data/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('progressContainer').style.display = 'none';
                
                if (data.success) {
                    showAlert('success', data.message || 'Данные успешно обновлены');
                    updateHistoryTable(data);
                } else {
                    showAlert('danger', data.error || 'Произошла ошибка при обновлении данных');
                }
            })
            .catch(error => {
                document.getElementById('progressContainer').style.display = 'none';
                showAlert('danger', 'Произошла ошибка при обновлении данных: ' + error.message);
            });
        });

        function showAlert(type, message) {
            const alertElement = document.getElementById('resultAlert');
            const messageElement = document.getElementById('alertMessage');
            
            // Удаляем старые классы стилей
            alertElement.className = 'alert alert-dismissible fade show';
            alertElement.classList.add(`alert-${type}`);
            
            messageElement.textContent = message;
            alertElement.style.display = 'block';
        }

        function updateHistoryTable(data) {
            const historyTableBody = document.getElementById('updateHistory');
            
            // Если это первая запись, очищаем таблицу
            if (historyTableBody.querySelector('td[colspan="5"]')) {
                historyTableBody.innerHTML = '';
            }
            
            // Добавляем новую запись в начало таблицы
            const newRow = document.createElement('tr');
            const now = new Date();
            newRow.innerHTML = `
                <td>${now.toLocaleDateString()}</td>
                <td>Обновление данных</td>
                <td>${data.added_count || 0} добавлено, ${data.updated_count || 0} обновлено, ${data.deleted_count || 0} удалено</td>
                <td><span class="badge bg-success">Выполнено</span></td>
                <td>${now.toLocaleTimeString()}</td>
            `;
            historyTableBody.insertBefore(newRow, historyTableBody.firstChild);
        }

        // Функция для получения CSRF-токена
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>